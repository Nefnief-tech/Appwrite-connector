<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connector Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&display=swap');
        body { font-family: 'Geist', sans-serif; background-color: #020617; }
        .card-glass { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(51, 65, 85, 0.5); backdrop-filter: blur(12px); border-radius: 1rem; }
        .btn-primary { background: #3b82f6; transition: 0.2s; }
        .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }
        .sidebar-item { transition: 0.2s; border-radius: 0.75rem; color: #94a3b8; }
        .sidebar-item:hover, .sidebar-item.active { background: #1e293b; color: white; }
        .sidebar-item.active { color: #60a5fa; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-200 overflow-hidden">
    <!-- Auth Wrapper -->
    <div id="authScreen" class="fixed inset-0 bg-slate-950 z-[100] flex items-center justify-center p-6">
        <div class="card-glass w-full max-w-md p-8 shadow-2xl border border-slate-800">
            <div class="flex flex-col items-center mb-8">
                <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-blue-500/20">
                    <i class="bi bi-shield-lock-fill text-white fs-4"></i>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-tight">Connector Console</h1>
                <p class="text-slate-500 text-sm mt-1" id="authSubtitle">Sign in to manage your encrypted data</p>
            </div>
            
            <div class="space-y-4">
                <input type="text" id="authUsername" class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl focus:border-blue-500 outline-none text-sm transition-all" placeholder="Username">
                <input type="password" id="authPassword" class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl focus:border-blue-500 outline-none text-sm transition-all" placeholder="Password">
                <button id="authBtn" onclick="handleAuth()" class="w-full btn-primary py-3 rounded-xl font-semibold text-white mt-2 shadow-lg shadow-blue-500/10">Continue</button>
                <button onclick="toggleAuthMode()" id="authToggle" class="w-full text-xs text-slate-500 hover:text-blue-400 mt-4 transition-colors">New here? Create an account</button>
            </div>
        </div>
    </div>

    <!-- Main Shell -->
    <div id="appShell" class="flex h-screen hidden">
        <!-- Sidebar -->
        <aside class="w-72 bg-slate-950 border-r border-slate-900 p-6 flex flex-col">
            <div class="flex items-center gap-3 px-2 mb-10">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                    <i class="bi bi-shield-lock-fill text-white"></i>
                </div>
                <span class="font-bold text-lg text-white">Console</span>
            </div>

            <nav class="flex-1 space-y-1">
                <p class="text-[10px] font-bold text-slate-600 uppercase tracking-widest px-3 mb-3">General</p>
                <div onclick="showTab('dashboard')" id="nav-dashboard" class="sidebar-item active p-3 px-4 flex items-center gap-3 cursor-pointer">
                    <i class="bi bi-grid-1x2"></i> Dashboard
                </div>
                <div onclick="showTab('records')" id="nav-records" class="sidebar-item p-3 px-4 flex items-center gap-3 cursor-pointer">
                    <i class="bi bi-folder2-open"></i> Records
                </div>
                <div onclick="showTab('users')" id="nav-users" class="sidebar-item p-3 px-4 flex items-center gap-3 cursor-pointer">
                    <i class="bi bi-people"></i> User Directory
                </div>
                <div onclick="showTab('roles')" id="nav-roles" class="sidebar-item p-3 px-4 flex items-center gap-3 cursor-pointer">
                    <i class="bi bi-key"></i> RBAC Settings
                </div>
                <div onclick="showTab('infra')" id="nav-infra" class="sidebar-item p-3 px-4 flex items-center gap-3 cursor-pointer">
                    <i class="bi bi-hdd-network"></i> Infrastructure
                </div>
                <div onclick="showTab('security')" id="nav-security" class="sidebar-item p-3 px-4 flex items-center gap-3 cursor-pointer">
                    <i class="bi bi-shield-lock"></i> Security
                </div>
            </nav>

            <div class="mt-auto p-4 card-glass bg-slate-900/40">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-xl bg-blue-600/20 text-blue-400 flex items-center justify-center font-bold" id="userInitial">U</div>
                    <div class="min-w-0">
                        <div class="text-sm font-bold text-white truncate" id="currentUsername">Username</div>
                        <div class="text-[10px] text-slate-500 truncate">Administrator</div>
                    </div>
                </div>
                <button onclick="logout()" class="w-full py-2 rounded-lg bg-slate-800 text-xs font-semibold hover:bg-red-900/20 hover:text-red-400 transition-all">Sign Out</button>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto bg-[#020617] p-8">
            <!-- Tab: Dashboard -->
            <section id="tab-dashboard" class="space-y-8">
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tight">System Overview</h1>
                    <p class="text-slate-500 mt-1">Real-time telemetry from your encrypted infrastructure.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="card-glass p-6">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">Total Records</div>
                        <div class="text-4xl font-bold text-white" id="stat-records">0</div>
                    </div>
                    <div class="card-glass p-6">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">Active Users</div>
                        <div class="text-4xl font-bold text-white" id="stat-users">0</div>
                    </div>
                    <div class="card-glass p-6">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">Total Traffic</div>
                        <div class="text-4xl font-bold text-blue-500" id="stat-requests">0</div>
                    </div>
                    <div class="card-glass p-6">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-widest mb-2">System Status</div>
                        <div id="stat-status" class="text-sm font-bold flex flex-col gap-1 mt-1">
                            <span class="text-green-500">HEALTHY</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card-glass p-6 overflow-hidden">
                        <h3 class="font-bold mb-4">Recent Users</h3>
                        <div id="recentUsersList" class="space-y-4"></div>
                    </div>
                    <div class="card-glass p-6 bg-blue-600/5 border-blue-500/20">
                        <h3 class="font-bold text-blue-400 mb-2">Quick Actions</h3>
                        <p class="text-xs text-slate-400 mb-4">Administrative shortcuts for rapid data management.</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="showTab('records')" class="p-3 rounded-xl bg-slate-900 border border-slate-800 text-xs hover:bg-slate-800 transition-all text-left">
                                <i class="bi bi-search mb-2 block"></i> Find Record
                            </button>
                            <button onclick="showTab('roles')" class="p-3 rounded-xl bg-slate-900 border border-slate-800 text-xs hover:bg-slate-800 transition-all text-left">
                                <i class="bi bi-shield-plus mb-2 block"></i> Add Role
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tab: Records -->
            <section id="tab-records" class="hidden space-y-8">
                <div class="flex justify-between items-end">
                    <div>
                        <h1 class="text-3xl font-bold text-white tracking-tight">Data Explorer</h1>
                        <p class="text-slate-500 mt-1">Manage all encrypted entries stored in the connector.</p>
                    </div>
                    <button onclick="openModal('recordModal')" class="btn-primary px-5 py-2.5 rounded-xl font-bold text-sm">Create Entry</button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 card-glass overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-900/50 border-b border-slate-800">
                                <tr>
                                    <th class="p-4 font-bold text-slate-500 uppercase text-[10px]">Entry ID</th>
                                    <th class="p-4 font-bold text-slate-500 uppercase text-[10px] text-right">Operation</th>
                                </tr>
                            </thead>
                            <tbody id="recordsTable" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                    <div class="card-glass p-6 h-fit sticky top-8">
                        <h3 class="font-bold text-sm text-slate-500 uppercase tracking-widest mb-6">Inspector</h3>
                        <div id="inspectContent" class="text-xs space-y-4">
                            <div class="p-4 bg-slate-950/50 rounded-xl border border-slate-800 text-slate-500 italic">Select a record to decrypt and inspect the payload.</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tab: Users -->
            <section id="tab-users" class="hidden space-y-8">
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tight">User Directory</h1>
                    <p class="text-slate-500 mt-1">List and manage users registered with this connector.</p>
                </div>
                <div class="card-glass overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-900/50 border-b border-slate-800">
                            <tr>
                                <th class="p-4 font-bold text-slate-500 uppercase text-[10px]">Username</th>
                                <th class="p-4 font-bold text-slate-500 uppercase text-[10px]">Created</th>
                                <th class="p-4 font-bold text-slate-500 uppercase text-[10px] text-right">ID</th>
                            </tr>
                        </thead>
                        <tbody id="userListFull" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </section>

            <!-- Tab: Roles -->
            <section id="tab-roles" class="hidden space-y-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-white tracking-tight">RBAC Engine</h1>
                        <p class="text-slate-500 mt-1">Define security policies and assign them to identities.</p>
                    </div>
                    <button onclick="openModal('roleModal')" class="bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-xl text-sm font-bold">New Role</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card-glass p-6 h-fit">
                        <h3 class="font-bold mb-6">Role Definitions</h3>
                        <div id="roleList" class="space-y-3"></div>
                    </div>
                    <div class="card-glass p-6">
                        <h3 class="font-bold mb-4">Assign Roles to Identity</h3>
                        <div class="flex gap-2 mb-6">
                            <input type="text" id="targetId" class="flex-1 bg-slate-900 border border-slate-800 p-2.5 rounded-xl outline-none focus:border-blue-500 text-sm" placeholder="Search by ID or Username...">
                            <button onclick="loadAssignment()" class="btn-primary px-4 rounded-xl text-xs font-bold">Load</button>
                        </div>
                        <div id="assignmentArea" class="hidden space-y-4">
                            <div id="roleCheckboxes" class="grid grid-cols-2 gap-2"></div>
                            <button onclick="saveAssignment()" class="w-full bg-white text-black py-2.5 rounded-xl font-bold text-sm mt-4 hover:bg-slate-200">Save Policy</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tab: Infrastructure -->
            <section id="tab-infra" class="hidden space-y-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-white tracking-tight">Infrastructure</h1>
                        <p class="text-slate-500 mt-1">Manage database redundancy and system mirrors.</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openModal('redisModal')" class="bg-slate-800 hover:bg-slate-700 px-5 py-2.5 rounded-xl font-bold text-sm">Add Redis Mirror</button>
                        <button onclick="openModal('dbModal')" class="btn-primary px-5 py-2.5 rounded-xl font-bold text-sm">Add DB Mirror</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-6">
                    <div class="card-glass p-6">
                        <h3 class="font-bold mb-6 flex items-center gap-2">
                            <i class="bi bi-shield-check text-green-500"></i>
                            Database Status & Redundancy
                        </h3>
                        <div class="overflow-hidden rounded-xl border border-slate-800">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-900/50">
                                    <tr>
                                        <th class="p-4 font-bold text-slate-500 uppercase text-[10px]">Database Name</th>
                                        <th class="p-4 font-bold text-slate-500 uppercase text-[10px]">Type</th>
                                        <th class="p-4 font-bold text-slate-500 uppercase text-[10px]">URL / Endpoint</th>
                                        <th class="p-4 font-bold text-slate-500 uppercase text-[10px]">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="dbStatusList" class="divide-y divide-slate-800">
                                    <!-- DB list will be here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card-glass p-6">
                        <h3 class="font-bold mb-6 flex items-center gap-2">
                            <i class="bi bi-lightning-charge-fill text-yellow-500"></i>
                            Cache Infrastructure (Redis)
                        </h3>
                        <div class="overflow-hidden rounded-xl border border-slate-800">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-900/50">
                                    <tr>
                                        <th class="p-4 font-bold text-slate-500 uppercase text-[10px]">Node Name</th>
                                        <th class="p-4 font-bold text-slate-500 uppercase text-[10px]">Type</th>
                                        <th class="p-4 font-bold text-slate-500 uppercase text-[10px]">Endpoint</th>
                                        <th class="p-4 font-bold text-slate-500 uppercase text-[10px]">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="redisStatusList" class="divide-y divide-slate-800">
                                    <!-- Redis list will be here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tab: Security -->
            <section id="tab-security" class="hidden space-y-8">
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tight">Security & Encryption</h1>
                    <p class="text-slate-500 mt-1">Manage your master keys and cryptographic policies.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card-glass p-8 border-yellow-500/20 bg-yellow-500/5">
                        <div class="flex items-start gap-4 mb-6">
                            <div class="w-12 h-12 rounded-2xl bg-yellow-500/20 text-yellow-500 flex items-center justify-center shrink-0">
                                <i class="bi bi-key-fill text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-white">Master Key Rotation</h3>
                                <p class="text-sm text-slate-400 mt-1">Rotate the AES-256 master key. All data will be decrypted with the old key and re-encrypted with a new randomly generated one.</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4 mb-8">
                            <div class="p-4 bg-slate-950 rounded-xl border border-slate-800">
                                <div class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-1">Rotation Policy</div>
                                <div class="text-sm text-slate-300 flex items-center gap-2">
                                    <i class="bi bi-check-circle-fill text-green-500"></i>
                                    Automated 24h Rotation Active
                                </div>
                            </div>
                            <div class="p-4 bg-slate-950 rounded-xl border border-slate-800">
                                <div class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-1">Redundancy Strategy</div>
                                <div class="text-sm text-slate-300">Mirrored Sync (Write-to-All)</div>
                            </div>
                        </div>

                        <button id="rerollBtn" onclick="triggerReroll()" class="w-full py-4 bg-white text-black rounded-2xl font-bold hover:bg-slate-200 transition-all flex items-center justify-center gap-2">
                            <i class="bi bi-arrow-repeat"></i>
                            Force Key Reroll Now
                        </button>
                        <button onclick="triggerWipe()" class="w-full py-3 mt-4 bg-red-900/20 text-red-400 border border-red-900/30 rounded-2xl font-bold hover:bg-red-900/40 transition-all flex items-center justify-center gap-2">
                            <i class="bi bi-trash3-fill"></i>
                            Wipe System Data
                        </button>
                    </div>

                    <div class="card-glass p-8 border-red-500/20 bg-red-500/5">
                        <div class="flex items-start gap-4 mb-6">
                            <div class="w-12 h-12 rounded-2xl bg-red-500/20 text-red-500 flex items-center justify-center shrink-0">
                                <i class="bi bi-shield-slash text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-white">Emergency Response</h3>
                                <p class="text-sm text-slate-400 mt-1">Immediate countermeasures for active security breaches.</p>
                            </div>
                        </div>
                        
                        <div class="p-5 bg-slate-950 rounded-2xl border border-slate-800 mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-bold text-white">Under Attack Mode</span>
                                <div id="attackStatus" class="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-800 text-slate-500">DISABLED</div>
                            </div>
                            <p class="text-[10px] text-slate-500 leading-relaxed">Activating this mode triggers an instant master key rotation across all nodes and clears all active sessions and caches.</p>
                        </div>

                        <button id="attackBtn" onclick="toggleAttackMode()" class="w-full py-4 bg-red-600 text-white rounded-2xl font-bold hover:bg-red-700 transition-all flex items-center justify-center gap-2 shadow-lg shadow-red-900/20">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            Toggle Under Attack Mode
                        </button>
                    </div>

                    <div class="card-glass p-8 border-blue-500/20 bg-blue-500/5">
                        <div class="flex items-start gap-4 mb-6">
                            <div class="w-12 h-12 rounded-2xl bg-blue-500/20 text-blue-500 flex items-center justify-center shrink-0">
                                <i class="bi bi-cpu text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-white">Performance Tuning</h3>
                                <p class="text-sm text-slate-400 mt-1">Manage infrastructure scaling and read/write distribution.</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="p-5 bg-slate-950 rounded-2xl border border-slate-800">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <div class="text-sm font-bold text-white">Load Balancer Mode</div>
                                        <div class="text-[10px] text-slate-500">Round-Robin Read Distribution</div>
                                    </div>
                                    <button onclick="toggleLB()" id="lbBtn" class="w-12 h-6 bg-slate-800 rounded-full p-1 transition-all flex items-center justify-start">
                                        <div class="w-4 h-4 bg-slate-500 rounded-full"></div>
                                    </button>
                                </div>
                                <div class="flex items-center gap-3 pt-4 border-t border-slate-900">
                                    <div class="flex-1">
                                        <div class="text-[10px] text-slate-500 uppercase font-bold">Redis Infrastructure</div>
                                        <div class="text-xs text-slate-300" id="redisCount">1 Primary Node</div>
                                    </div>
                                    <div class="text-green-500 animate-pulse">
                                        <i class="bi bi-activity"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-glass p-8">
                        <h3 class="font-bold mb-4">Cryptographic Audit</h3>
                        <p class="text-xs text-slate-500 mb-6">Last 3 key rotation events detected in the infrastructure.</p>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3 p-3 bg-slate-900/40 rounded-xl border border-slate-800">
                                <i class="bi bi-shield-check text-green-500"></i>
                                <div class="flex-1">
                                    <div class="text-xs font-bold text-white">Scheduled Rotation</div>
                                    <div class="text-[10px] text-slate-500">Successful â€¢ System Automator</div>
                                </div>
                                <div class="text-[10px] text-slate-600">Today</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Base -->
    <div id="modalOverlay" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-[150] hidden items-center justify-center p-6">
        <div id="recordModal" class="modal-box card-glass bg-slate-950 w-full max-w-xl p-8 hidden flex flex-col gap-6 shadow-2xl">
            <h3 class="text-xl font-bold text-white">New Encrypted Entry</h3>
            <textarea id="recordPayload" class="w-full bg-slate-900 border border-slate-800 p-4 rounded-xl font-mono text-xs text-blue-400 h-64 focus:border-blue-500 outline-none" placeholder='{"key": "value"}'></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="closeModals()" class="px-5 py-2 rounded-xl hover:bg-slate-900 text-sm font-semibold">Cancel</button>
                <button onclick="saveRecord()" class="btn-primary px-6 py-2 rounded-xl text-sm font-bold">Store Record</button>
            </div>
        </div>
        <div id="roleModal" class="modal-box card-glass bg-slate-950 w-full max-w-md p-8 hidden flex flex-col gap-6 shadow-2xl">
            <h3 class="text-xl font-bold text-white">Define Security Role</h3>
            <input type="text" id="newRoleName" class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl outline-none" placeholder="Role Name (e.g. storage_admin)">
            <div class="space-y-3">
                <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Capabilities</p>
                <div class="grid grid-cols-2 gap-2">
                    <label class="p-2.5 bg-slate-900 border border-slate-800 rounded-xl flex items-center gap-2 cursor-pointer hover:bg-slate-800"><input type="checkbox" value="data:read" class="perm-check"> <span class="text-xs">data:read</span></label>
                    <label class="p-2.5 bg-slate-900 border border-slate-800 rounded-xl flex items-center gap-2 cursor-pointer hover:bg-slate-800"><input type="checkbox" value="data:write" class="perm-check"> <span class="text-xs">data:write</span></label>
                    <label class="p-2.5 bg-slate-900 border border-slate-800 rounded-xl flex items-center gap-2 cursor-pointer hover:bg-slate-800"><input type="checkbox" value="roles:manage" class="perm-check"> <span class="text-xs">roles:manage</span></label>
                    <label class="p-2.5 bg-slate-900 border border-slate-800 rounded-xl flex items-center gap-2 cursor-pointer hover:bg-slate-800"><input type="checkbox" value="profile:read" class="perm-check"> <span class="text-xs">profile:read</span></label>
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeModals()" class="px-5 py-2 rounded-xl hover:bg-slate-900 text-sm font-semibold">Cancel</button>
                <button onclick="saveRoleDef()" class="btn-primary px-6 py-2 rounded-xl text-sm font-bold">Create Policy</button>
            </div>
        </div>
        <div id="dbModal" class="modal-box card-glass bg-slate-950 w-full max-w-md p-8 hidden flex flex-col gap-6 shadow-2xl">
            <h3 class="text-xl font-bold text-white">Add Database Mirror</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">Display Name</label>
                    <input type="text" id="dbName" class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl outline-none" placeholder="e.g. Backup Server (EU)">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">Postgres URL</label>
                    <input type="text" id="dbUrl" class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl outline-none font-mono text-xs" placeholder="postgres://user:pass@host:port/db">
                </div>
                <div class="p-4 bg-blue-600/10 border border-blue-500/20 rounded-xl">
                    <p class="text-[10px] text-blue-400">Adding a mirror will automatically initialize the required schema. Ensure the provided user has permissions to CREATE TABLE.</p>
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeModals()" class="px-5 py-2 rounded-xl hover:bg-slate-900 text-sm font-semibold">Cancel</button>
                <button onclick="addMirror()" class="btn-primary px-6 py-2 rounded-xl text-sm font-bold">Initialize & Connect</button>
            </div>
        </div>
        <div id="redisModal" class="modal-box card-glass bg-slate-950 w-full max-w-md p-8 hidden flex flex-col gap-6 shadow-2xl">
            <h3 class="text-xl font-bold text-white">Add Redis Mirror</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">Node Name</label>
                    <input type="text" id="redisName" class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl outline-none" placeholder="e.g. Redis Replica (Asia)">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">Redis URL</label>
                    <input type="text" id="redisUrlInput" class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl outline-none font-mono text-xs" placeholder="redis://127.0.0.1:6379">
                </div>
                <div class="p-4 bg-yellow-600/10 border border-yellow-500/20 rounded-xl">
                    <p class="text-[10px] text-yellow-400">New mirrors will be automatically synchronized on first use. Ensure the node is accessible from this server.</p>
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeModals()" class="px-5 py-2 rounded-xl hover:bg-slate-900 text-sm font-semibold">Cancel</button>
                <button onclick="addRedisMirror()" class="btn-primary px-6 py-2 rounded-xl text-sm font-bold">Connect Mirror</button>
            </div>
        </div>
        <!-- Confirmation Modals -->
        <div id="confirmRerollModal" class="modal-box card-glass bg-slate-950 w-full max-w-md p-8 hidden flex flex-col gap-6 shadow-2xl">
            <h3 class="text-xl font-bold text-white">Confirm Key Rotation</h3>
            <p class="text-sm text-slate-400">DANGER: This will re-encrypt your entire database. This operation may take some time and might cause temporary read-only state.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModals()" class="px-5 py-2 rounded-xl hover:bg-slate-900 text-sm font-semibold">Cancel</button>
                <button onclick="executeReroll()" class="bg-white text-black px-6 py-2 rounded-xl text-sm font-bold hover:bg-slate-200">Start Rotation</button>
            </div>
        </div>
        <div id="confirmAttackModal" class="modal-box card-glass bg-slate-950 w-full max-w-md p-8 hidden flex flex-col gap-6 shadow-2xl border-red-500/30">
            <h3 class="text-xl font-bold text-white text-red-500">Emergency Protocol</h3>
            <p class="text-sm text-slate-400">Activating Under Attack Mode will immediately rotate all encryption keys and invalidate all current sessions. Use only in case of an active breach.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModals()" class="px-5 py-2 rounded-xl hover:bg-slate-900 text-sm font-semibold">Cancel</button>
                <button onclick="executeAttackMode()" class="bg-red-600 text-white px-6 py-2 rounded-xl text-sm font-bold hover:bg-red-700">Activate Protocol</button>
            </div>
        </div>
        <div id="confirmWipeModal" class="modal-box card-glass bg-slate-950 w-full max-w-md p-8 hidden flex flex-col gap-6 shadow-2xl border-red-500/50">
            <h3 class="text-xl font-bold text-white text-red-500 uppercase tracking-tighter">System Factory Reset</h3>
            <p class="text-sm text-slate-400">DANGER: This will permanently delete ALL data, users, and configurations. This action is irreversible.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModals()" class="px-5 py-2 rounded-xl hover:bg-slate-900 text-sm font-semibold">Cancel</button>
                <button onclick="executeWipe()" class="bg-red-600 text-white px-6 py-2 rounded-xl text-sm font-bold hover:bg-red-700">Wipe Everything</button>
            </div>
        </div>
    </div>

    <script>
        let session = JSON.parse(localStorage.getItem('connector_session'));
        let isReg = false;
        let activeTab = 'dashboard';

        const api = async (p, m = 'GET', b = null) => {
            // Ensure path is absolute from root if it doesn't start with /
            const url = p.startsWith('/') ? p : `/${p}`;
            console.log(`API Call: ${m} ${url}`);
            const h = { 
                'Content-Type': 'application/json', 
                'x-appwrite-key': 'secret_key', 
                'x-appwrite-jwt': session?.id || '', // Standalone system uses the session id as JWT
                'x-appwrite-user-id': session?.user_id || '' 
            };
            const r = await fetch(url, { method: m, headers: h, body: b ? JSON.stringify(b) : null });
            if (!r.ok) {
                const errText = await r.text();
                console.error(`API Error ${r.status}: ${errText}`);
                throw new Error(errText);
            }
            const ct = r.headers.get("content-type");
            const data = ct && ct.includes("application/json") ? await r.json() : { message: await r.text() };
            console.log(`API Success: ${m} ${url}`, data);
            return data;
        };

        const toggleAuthMode = () => {
            isReg = !isReg;
            document.getElementById('authSubtitle').innerText = isReg ? 'Create an administrative account' : 'Sign in to manage your encrypted data';
            document.getElementById('authBtn').innerText = isReg ? 'Register Account' : 'Sign In';
            document.getElementById('authToggle').innerText = isReg ? 'Already have an account? Sign in' : 'New here? Create an account';
        };

        const handleAuth = async () => {
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            // Ensure email doesn't have double suffix
            const email = username.includes('@') ? username : `${username}@local.system`;
            try {
                if (isReg) {
                    // Registration uses /v1/account
                    await api('/v1/account', 'POST', { name: username, email: email, password, userId: 'unique()' });
                    alert('Registration successful. Please sign in.');
                    toggleAuthMode();
                } else {
                    // Login uses /v1/account/sessions/email
                    session = await api('/v1/account/sessions/email', 'POST', { email: email, password });
                    localStorage.setItem('connector_session', JSON.stringify(session));
                    initApp();
                }
            } catch(e) { alert(e.message); }
        };

        const logout = () => { localStorage.removeItem('connector_session'); location.reload(); };

        const showTab = (t) => {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            document.getElementById('tab-' + t).classList.remove('hidden');
            document.getElementById('nav-' + t).classList.add('active');
            activeTab = t;
            if(t === 'dashboard') loadStats();
            if(t === 'records') loadRecords();
            if(t === 'users') loadUsers();
            if(t === 'roles') loadRoles();
            if(t === 'infra') loadDbStatus();
            if(t === 'security') loadSecurityStatus();
        };

        const loadSecurityStatus = async () => {
            try {
                const s = await api('/admin/security/status');
                const attackStatus = document.getElementById('attackStatus');
                const lbToggle = document.getElementById('lbBtn');
                const redisCount = document.getElementById('redisCount');

                if (attackStatus) {
                    attackStatus.innerText = s.under_attack ? 'ACTIVATED' : 'DISABLED';
                    attackStatus.className = `px-2 py-0.5 rounded text-[10px] font-bold ${s.under_attack ? 'bg-red-500 text-white' : 'bg-slate-800 text-slate-500'}`;
                }
                
                if (lbToggle) {
                    lbToggle.className = `w-12 h-6 rounded-full p-1 transition-all flex items-center ${s.load_balancer_mode ? 'bg-blue-600 justify-end' : 'bg-slate-800 justify-start'}`;
                    const dot = lbToggle.querySelector('div');
                    if (dot) dot.className = `w-4 h-4 rounded-full ${s.load_balancer_mode ? 'bg-white' : 'bg-slate-500'}`;
                }
                
                if (redisCount) {
                    redisCount.innerText = `${s.redis_mirrors_count + 1} Node${s.redis_mirrors_count > 0 ? 's' : ''} (1 Primary${s.redis_mirrors_count > 0 ? `, ${s.redis_mirrors_count} Mirror` : ''})`;
                }
            } catch(e) { console.error('Security Status Load Failed:', e); }
        };

        const toggleAttackMode = () => {
            console.log('toggleAttackMode triggered');
            openModal('confirmAttackModal');
        };

        const executeAttackMode = async () => {
            closeModals();
            const btn = document.getElementById('attackBtn');
            const original = btn ? btn.innerHTML : 'Toggle Under Attack Mode';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-shield-slash animate-pulse"></i> Processing Emergency...';
            }
            try {
                await api('/admin/security/attack', 'POST');
                await loadSecurityStatus();
            } catch(e) { alert('Emergency Mode Error: ' + e.message); }
            finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = original;
                }
            }
        };

        const toggleLB = async () => {
            console.log('toggleLB triggered');
            try {
                await api('/admin/security/load-balancer', 'POST');
                await loadSecurityStatus();
            } catch(e) { alert('Load Balancer Error: ' + e.message); }
        };

        const triggerReroll = () => {
            console.log('triggerReroll triggered');
            openModal('confirmRerollModal');
        };

        const triggerWipe = () => {
            console.log('triggerWipe triggered');
            openModal('confirmWipeModal');
        };

        const executeWipe = async () => {
            closeModals();
            try {
                await api('/admin/security/wipe', 'POST');
                alert('System Reset Complete. Logging out.');
                logout();
            } catch(e) { alert('Wipe Error: ' + e.message); }
        };

        const executeReroll = async () => {
            closeModals();
            const btn = document.getElementById('rerollBtn');
            const originalContent = btn ? btn.innerHTML : 'Force Key Reroll Now';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-arrow-repeat animate-spin"></i> Processing Rotation...';
            }
            try {
                await api('/admin/security/reroll', 'POST');
                alert('Success: Encryption key rotated and data re-encrypted across all nodes.');
                await loadSecurityStatus();
            } catch(e) { alert('Critical Error: ' + e.message); }
            finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            }
        };

        const loadDbStatus = async () => {
            const list = document.getElementById('dbStatusList');
            list.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-500">Scanning infrastructure...</td></tr>';
            try {
                const dbs = await api('/admin/db-status');
                list.innerHTML = dbs.map(db => `
                    <tr class="hover:bg-slate-900/20">
                        <td class="p-4 font-bold text-white">${db.name}</td>
                        <td class="p-4 text-xs"><span class="px-2 py-0.5 rounded ${db.is_mirror ? 'bg-purple-500/10 text-purple-400 border border-purple-500/20' : 'bg-blue-500/10 text-blue-400 border border-blue-500/20'}">${db.is_mirror ? 'MIRROR' : 'PRIMARY'}</span></td>
                        <td class="p-4 font-mono text-[10px] text-slate-500">${db.url}</td>
                        <td class="p-4">
                            <span class="flex items-center gap-2 ${db.online ? 'text-green-500' : 'text-red-500'} font-bold text-xs uppercase tracking-widest">
                                <span class="w-2 h-2 rounded-full ${db.online ? 'bg-green-500 animate-pulse' : 'bg-red-500'}"></span>
                                ${db.online ? 'Online' : 'Offline'}
                            </span>
                        </td>
                    </tr>
                `).join('');
                await loadRedisStatus();
            } catch(e) { list.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Failed to load status: ${e.message}</td></tr>`; }
        };

        const loadRedisStatus = async () => {
            const list = document.getElementById('redisStatusList');
            list.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-500">Pinging cache nodes...</td></tr>';
            try {
                const nodes = await api('/admin/redis');
                list.innerHTML = nodes.map(node => `
                    <tr class="hover:bg-slate-900/20">
                        <td class="p-4 font-bold text-white">${node.name}</td>
                        <td class="p-4 text-xs"><span class="px-2 py-0.5 rounded ${node.is_mirror ? 'bg-yellow-500/10 text-yellow-400 border border-yellow-500/20' : 'bg-blue-500/10 text-blue-400 border border-blue-500/20'}">${node.is_mirror ? 'REPLICA' : 'PRIMARY'}</span></td>
                        <td class="p-4 font-mono text-[10px] text-slate-500">${node.url}</td>
                        <td class="p-4">
                            <span class="flex items-center gap-2 ${node.online ? 'text-green-500' : 'text-red-500'} font-bold text-xs uppercase tracking-widest">
                                <span class="w-2 h-2 rounded-full ${node.online ? 'bg-green-500 animate-pulse' : 'bg-red-500'}"></span>
                                ${node.online ? 'Active' : 'Disconnected'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            } catch(e) { list.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Ping failed: ${e.message}</td></tr>`; }
        };

        const addMirror = async () => {
            const name = document.getElementById('dbName').value;
            const url = document.getElementById('dbUrl').value;
            if(!name || !url) return alert('Name and URL are required');
            try {
                await api('/admin/databases', 'POST', { name, url });
                closeModals();
                loadDbStatus();
            } catch(e) { alert(e.message); }
        };

        const addRedisMirror = async () => {
            const name = document.getElementById('redisName').value;
            const url = document.getElementById('redisUrlInput').value;
            if(!name || !url) return alert('Name and URL are required');
            try {
                await api('/admin/redis', 'POST', { name, url });
                closeModals();
                loadDbStatus();
            } catch(e) { alert(e.message); }
        };

        const loadStats = async () => {
            const s = await api('/admin/stats');
            document.getElementById('stat-records').innerText = s.total_records;
            document.getElementById('stat-users').innerText = s.total_users;
            document.getElementById('stat-requests').innerText = s.total_requests;
            
            let statusHtml = '';
            if (s.under_attack) {
                statusHtml += '<span class="text-red-500 flex items-center gap-1"><i class="bi bi-exclamation-triangle"></i> UNDER ATTACK</span>';
            } else {
                statusHtml += '<span class="text-green-500 flex items-center gap-1"><i class="bi bi-check-circle"></i> SYSTEM HEALTHY</span>';
            }
            if (s.load_balancer_mode) {
                statusHtml += '<span class="text-blue-400 text-[10px] uppercase tracking-tighter">LB Mode Enabled</span>';
            }
            document.getElementById('stat-status').innerHTML = statusHtml;

            const u = await api('/admin/users');
            const list = document.getElementById('recentUsersList');
            list.innerHTML = u.slice(0, 5).map(user => `
                <div class="flex items-center justify-between p-3 bg-slate-900/40 rounded-xl border border-slate-800">
                    <span class="text-sm font-semibold">${user.username}</span>
                    <span class="text-[10px] text-slate-500">${new Date(user.created_at).toLocaleDateString()}</span>
                </div>
            `).join('');
        };

        const loadRecords = async () => {
            const d = await api('/data');
            document.getElementById('recordsTable').innerHTML = d.map(r => `
                <tr class="hover:bg-slate-900/20 transition-all cursor-pointer group" onclick="inspect('${r.id}')">
                    <td class="p-4 font-mono text-[10px] text-slate-400">
                        ${r.id}
                        <div class="text-[8px] text-slate-600 mt-0.5">${new Date(r.created_at).toLocaleString()}</div>
                    </td>
                    <td class="p-4 text-right">
                        <i class="bi bi-chevron-right text-slate-700 group-hover:text-blue-500"></i>
                    </td>
                </tr>
            `).join('');
        };

        const inspect = async (id) => {
            const body = document.getElementById('inspectContent');
            body.innerHTML = '<div class="p-4 bg-slate-950 rounded-xl text-[10px] text-blue-400">Decrypting...</div>';
            try {
                const data = await api(`/data/${id}`);
                body.innerHTML = `
                    <div class="p-4 bg-slate-950 rounded-xl border border-slate-800 text-[10px] text-green-400 font-mono overflow-auto max-h-96 whitespace-pre-wrap">${JSON.stringify(data, null, 2)}</div>
                    <button class="w-full py-2 bg-slate-900 rounded-lg text-[10px] font-bold mt-2 hover:bg-slate-800">Copy to Clipboard</button>
                `;
            } catch(e) { body.innerHTML = '<div class="p-4 bg-red-900/20 rounded-xl border border-red-900/30 text-red-400 text-xs font-bold">Access Denied</div>'; }
        };

        const loadUsers = async () => {
            const u = await api('/admin/users');
            document.getElementById('userListFull').innerHTML = u.map(user => `
                <tr class="hover:bg-slate-900/20 transition-all">
                    <td class="p-4 font-bold text-white">${user.username}</td>
                    <td class="p-4 text-slate-500 text-xs">${new Date(user.created_at).toLocaleString()}</td>
                    <td class="p-4 text-right font-mono text-[10px] text-slate-600">${user.id}</td>
                </tr>
            `).join('');
        };

        const loadRoles = async () => {
            const roles = await api('/roles');
            document.getElementById('roleList').innerHTML = roles.map(r => `
                <div class="p-4 bg-slate-900/50 rounded-xl border border-slate-800">
                    <div class="text-sm font-bold text-white mb-2">${r.name}</div>
                    <div class="flex gap-1 flex-wrap">
                        ${r.permissions.map(p => `<span class="text-[9px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded border border-slate-700 font-mono">${p}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        };

        const loadAssignment = async () => {
            const id = document.getElementById('targetId').value;
            const profile = await api(`/profile/${id}`);
            const roles = await api('/roles');
            document.getElementById('assignmentArea').classList.remove('hidden');
            document.getElementById('roleCheckboxes').innerHTML = roles.map(r => `
                <label class="p-3 bg-slate-900/50 border border-slate-800 rounded-xl flex items-center gap-2 cursor-pointer text-xs">
                    <input type="checkbox" value="${r.name}" ${profile.roles.includes(r.name) ? 'checked' : ''} class="role-check"> ${r.name}
                </label>
            `).join('');
        };

        const saveAssignment = async () => {
            const id = document.getElementById('targetId').value;
            const rs = Array.from(document.querySelectorAll('.role-check:checked')).map(c => c.value);
            await api('/profile', 'POST', { user_id: id, roles: rs });
            alert('Policy updated');
        };

        const saveRoleDef = async () => {
            const name = document.getElementById('newRoleName').value;
            const perms = Array.from(document.querySelectorAll('.perm-check:checked')).map(c => c.value);
            await api('/roles', 'POST', { name, permissions: perms });
            closeModals();
            loadRoles();
        };

        const saveRecord = async () => {
            const payload = JSON.parse(document.getElementById('recordPayload').value);
            await api('/data', 'POST', payload);
            closeModals();
            loadRecords();
        };

        const openModal = (id) => {
            document.getElementById('modalOverlay').classList.replace('hidden', 'flex');
            document.querySelectorAll('.modal-box').forEach(m => m.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };
        const closeModals = () => document.getElementById('modalOverlay').classList.replace('flex', 'hidden');

        const initApp = async () => {
            if(!session) return;
            
            // If session is an AppwriteSession object, it might not have the name
            if (!session.name && !session.username) {
                try {
                    const account = await api('/v1/account');
                    session.username = account.name || account.email || 'User';
                } catch (e) {
                    session.username = 'User';
                }
            } else if (session.name) {
                session.username = session.name;
            }

            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appShell').classList.remove('hidden');
            
            const displayName = session.username || 'User';
            document.getElementById('currentUsername').innerText = displayName;
            document.getElementById('userInitial').innerText = displayName[0].toUpperCase();
            showTab('dashboard');
        };

        if(session) initApp();
    </script>
</body>
</html>